package co.datainsider.jobworker.util

import co.datainsider.jobscheduler.util
import com.fasterxml.jackson.databind.JsonNode
import com.twitter.inject.Test
import co.datainsider.schema.domain.column.Column
import datainsider.client.exception.InternalError

import scala.jdk.CollectionConverters.asScalaIteratorConverter


/**
  * created 2023-04-07 3:17 PM
  *
  * @author tvc12 - Thien Vi
  */
class ShopeeUtilsTest extends Test {
  test("get order columns") {
    val json =
      """
[{"sample":"201214JASXYXY6","type":"string","name":"order_sn","key":"fZRMxBj","description":"Return by default. Shopee's unique identifier for an order.\t"},{"sample":"MY","type":"string","name":"region","key":"FtPhET","description":"Return by default. The two-digit code representing the region where the order was made.\t"},{"sample":"MYR","type":"string","name":"currency","key":"pWwbHnM","description":"Return by default. The three-digit code representing the currency unit for which the order was paid.\t"},{"sample":"false","type":"boolean","name":"cod","key":"zxneSmi","description":"Return by default. This value indicates whether the order was a COD (cash on delivery) order.\t"},{"sample":"1004.00","type":"float","name":"total_amount","key":"DxWMCdX","description":"The total amount paid by the buyer for the order. This amount includes the total sale price of items, shipping cost beared by buyer; and offset by Shopee promotions if applicable. This value will only return after the buyer has completed payment for the order.\t"},{"sample":"CANCELLED","type":"string","name":"order_status","key":"hGxNetj","description":"Return by default. Enumerated type that defines the current status of the order.\t"},{"sample":"Standard Delivery","type":"string","name":"shipping_carrier","key":"PhXahyh","description":"The logistics service provider that the buyer selected for the order to deliver items.\t"},{"sample":"Bank Transfer","type":"string","name":"payment_method","key":"cCxMSsf","description":"The payment method that the buyer selected to pay for the order."},{"sample":"4.0","type":"float","name":"estimated_shipping_fee","key":"TFMKsXH","description":"The estimated shipping fee is an estimation calculated by Shopee based on specific logistics courier's standard.\t"},{"sample":"","type":"string","name":"message_to_seller","key":"fcTemAF","description":"Return by default. Message to seller.\t"},{"sample":"1607930885","type":"timestamp","name":"create_time","key":"RZyiXHB","description":"Return by default. Timestamp that indicates the date and time that the order was created.\t"},{"sample":"1608134691","type":"timestamp","name":"update_time","key":"aXZpQT","description":"Return by default. Timestamp that indicates the last time that there was a change in value of order, such as order status changed from 'Paid' to 'Completed'.\t"},{"sample":"2","type":"int","name":"days_to_ship","key":"ySXWyQp","description":"Return by default. Shipping preparation time set by the seller when listing item on Shopee.\t"},{"sample":"1608103685","type":"timestamp","name":"ship_by_date","key":"xBnHfNE","description":"Return by default. The deadline to ship out the parcel.\t"},{"sample":"9193214","type":"int","name":"buyer_user_id","key":"bRMmhzT","description":"The user id of buyer of this order\t"},{"sample":"Tom","type":"string","name":"buyer_username","key":"BkHpMs","description":"The name of buyer\t"},{"description":"This object contains detailed breakdown for the recipient address.In order to better protect the privacy of buyers, the Open API will launch the buyer info masking function to mask the buyer information displayed to sellers. More details may refer the announcement.","sample":"","key":"fXjRknT","type":"object","children":[{"sample":"Max","type":"string","name":"name","key":"nSdbDWr","description":"Recipient's name for the address.\t"},{"sample":"3828203","type":"string","name":"phone","key":"DxjMWJD","description":"Recipient's phone number input when order was placed.\t"},{"sample":"Sara","type":"string","name":"town","key":"GhaPBet","description":" The town of the recipient's address. Whether there is a town will depend on the region and/or country.\t"},{"sample":"Dada","type":"string","name":"district","key":"bczGkjr","description":"The district of the recipient's address. Whether there is a district will depend on the region and/or country.\t"},{"sample":"Asajaya","type":"string","name":"city","key":"PFZsWer","description":"The city of the recipient's address. Whether there is a city will depend on the region and/or country.\t"},{"sample":"Sarawak","type":"string","name":"state","key":"hxpEfxa","description":"The state/province of the recipient's address. Whether there is a state/province will depend on the region and/or country.\t"},{"sample":"MY","type":"string","name":"region","key":"EGxnmDG","description":"The two-digit code representing the region of the Recipient.\t"},{"sample":"40009","type":"string","name":"zipcode","key":"dMTMSfF","description":"Recipient's postal code.\t"},{"sample":"C-15-14 BLOK C JALAN 30/146, Asajaya, 40009, Sarawak","type":"string","name":"full_address","key":"EMftjDb","description":"The full address of the recipient, including country, state, even street, and etc.\t"}],"name":"recipient_address"},{"sample":"2.0","type":"float","name":"actual_shipping_fee","key":"PjTcxDG","description":"The actual shipping fee of the order if available from external logistics partners.\t"},{"sample":"false","type":"boolean","name":"goods_to_declare","key":"YXXDApd","description":"Only work for cross-border order.This value indicates whether the order contains goods that are required to declare at customs. \"T\" means true and it will mark as \"T\" on the shipping label; \"F\" means false and it will mark as \"P\" on the shipping label. This value is accurate ONLY AFTER the order trackingNo is generated, please capture this value AFTER your retrieve the trackingNo.\t"},{"sample":"haha","type":"string","name":"note","key":"KKiwdys","description":"The note seller made for own reference.\t"},{"sample":"1608103685","type":"timestamp","name":"note_update_time","key":"ReiFtFG","description":"Update time for the note.\t"},{"description":"This object contains the detailed breakdown for the result of this API call.\t","sample":"","key":"Sycrznr","type":"object[]","children":[{"sample":"2600144043","type":"int","name":"item_id","key":"hPEtaFk","description":"Shopee's unique identifier for an item."},{"sample":"backpack","type":"string","name":"item_name","key":"eRptKYe","description":"The name of the item."},{"sample":"sku","type":"string","name":"item_sku","key":"JXrjbnH","description":" A item SKU (stock keeping unit) is an identifier defined by a seller, sometimes called parent SKU. Item SKU can be assigned to an item in Shopee Listings.\t"},{"sample":"105933822990","type":"int","name":"model_id","key":"FjiFdnQ","description":"ID of the model that belongs to the same item.\t"},{"sample":"Grey blue 40*60cm","type":"string","name":"model_name","key":"aQEJxmp","description":"Name of the model that belongs to the same item. A seller can offer models of the same item. For example, the seller could create a fixed-priced listing for a t-shirt design and offer the shirt in different colors and sizes. In this case, each color and size combination is a separate model. Each model can have a different quantity and price.\t"},{"sample":"DMM1952804068","type":"string","name":"model_sku","key":"kDpaRTP","description":"A model SKU (stock keeping unit) is an identifier defined by a seller. It is only intended for the seller's use. Many sellers assign a SKU to an item of a specific type, size, and color, which are models of one item in Shopee Listings.\t"},{"sample":"1","type":"int","name":"model_quantity_purchased","key":"PdXaBbF","description":"The number of identical items purchased at the same time by the same buyer from one listing/item.\t"},{"sample":"1000.0","type":"float","name":"model_original_price","key":"DmfrGeY","description":"The original price of the item in the listing currency.\t"},{"sample":"800.0","type":"float","name":"model_discounted_price","key":"bHxkeCE","description":"The after-discount price of the item in the listing currency. If there is no discount, this value will be same as that of model_original_price. In case of bundle deal item, this value will return 0 as by design bundle deal discount will not be breakdown to item/model level. Due to technical restriction, the value will return the price before bundle deal if we don't configure it to 0. Please call GetEscrowDetails if you want to calculate item-level discounted price for bundle deal item.\t"},{"sample":"false","type":"boolean","name":"wholesale","key":"JKeicSc","description":"This value indicates whether buyer buy the order item in wholesale price.\t"},{"sample":"1.0","type":"float","name":"weight","key":"DatWRG","description":"The weight of the item\t"},{"sample":"false","type":"boolean","name":"add_on_deal","key":"dBibzmc","description":"To indicate if this item belongs to an addon deal.\t"},{"sample":"false","type":"boolean","name":"main_item","key":"kYpZAaC","description":"To indicate if this item is main item or sub item. True means main item, false means sub item.\t"},{"sample":"7850296","type":"int","name":"add_on_deal_id","key":"BxHedWF","description":"A unique ID to distinguish groups of items in Cart, and Order. (e.g. AddOnDeal)\t"},{"sample":"flash_sale","type":"string","name":"promotion_type","key":"MGGFtys","description":"Available typeï¼šproduct_promotion, flash_sale, group_by, bundle_deal, add_on_deal_main, add_on_deal_sub, add_on_free_gift_main, add_on_free_gift_sub"},{"sample":"7850297","type":"int","name":"promotion_id","key":"zjNXrQG","description":"The ID of the promotion.\t"},{"sample":"2600144043","type":"int","name":"order_item_id","key":"GZxwADy","description":"The identify of order item. For items in one same bundle deal promotion, the order_item_id should share the same id, such as 1,2. For items not in bundle deal promotion, the order_item_id should be the same as item_id."},{"sample":"7850298","type":"int","name":"promotion_group_id","key":"SixJCBm","description":"The identify of product promotion."},{"description":" Image info of the product.","sample":"","key":"TzbzPGp","type":"object","children":[{"sample":"https://cf.shopee.com.my/file/a9930777e98444e8a55f2d23646b8026_tn","type":"string","name":"image_url","key":"DwnJapM","description":"The image url of the product. Default to be variation image, if the model does not have a variation image, will use an item main image instead."}],"name":"image_info"},{"sample":"[\"IDL\", \"IDG\"]","type":"string[]","name":"product_location_id","key":"JPZtbnE","description":"The list of warehouse IDs of the item."},{"description":"For each item in order, return whether the item is a prescription item or not.","name":"is_prescription_item","sample":"false","type":"boolean","required":null,"key":"tnktrWz"},{"description":"determine if item is B2C_shop_item.","name":"is_b2c_owned_item","sample":"false","type":"boolean","required":null,"key":"XHFjRey"}],"name":"item_list"},{"sample":"1607930885","type":"timestamp","name":"pay_time","key":"SKkhSxw","description":"The time when the order status is updated from UNPAID to PAID. This value is NULL when order is not paid yet.\t"},{"sample":"","type":"string","name":"dropshipper","key":"cPCAntt","description":"For Indonesia orders only. The name of the dropshipper.\t"},{"sample":"","type":"string","name":"dropshipper_phone","key":"NQbGAr","description":"The phone number of dropshipper, could be empty."},{"sample":"false","type":"boolean","name":"split_up","key":"RrSCdTi","description":"To indicate whether this order is split to fullfil order(forder) level. "},{"sample":"Need to Modify Order","type":"string","name":"buyer_cancel_reason","key":"trPHHnZ","description":"Cancel reason from buyer, could be empty."},{"sample":"system","type":"string","name":"cancel_by","key":"SmCNZEF","description":"Could be one of buyer, seller, system or Ops.\t"},{"sample":"BACKEND_LOGISTICS_NOT_STARTED","type":"string","name":"cancel_reason","key":"GBxstJM","description":"Use this field to get reason for buyer, seller, and system cancellation.\t"},{"sample":"false","type":"boolean","name":"actual_shipping_fee_confirmed","key":"pmFEdxs","description":"Use this filed to judge whether the actual_shipping_fee is confirmed.\t"},{"sample":"","type":"string","name":"buyer_cpf_id","key":"FCyDsak","description":"Buyer's CPF number for taxation and invoice purposes. Only for Brazil order.\t"},{"sample":"fulfilled_by_shopee","type":"string","name":"fulfillment_flag","key":"DSCSpGt","description":"Use this field to indicate the order is fulfilled by shopee or seller. Applicable values: fulfilled_by_shopee, fulfilled_by_cb_seller, fulfilled_by_local_seller.\t"},{"sample":"0","type":"timestamp","name":"pickup_done_time","key":"jbTEzFn","description":"The timestamp when pickup is done."},{"description":"The list of package under an order","sample":"","key":"RNQiDjD","type":"object[]","children":[{"sample":"\"61630084074470\"","type":"string","name":"package_number","key":"AbmixMY","description":"Shopee's unique identifier for the package under an order."},{"sample":"LOGISTICS_INVALID","type":"string","name":"logistics_status","key":"fkQkWYB","description":"The Shopee logistics status for the order. Applicable values: See Data Definition-LogisticsStatus."},{"sample":"Standard Delivery","type":"string","name":"shipping_carrier","key":"jSnyXyD","description":"The logistics service provider that the buyer selected for the order to deliver items."},{"description":"The lis of items.","sample":"","key":"fcjrSwn","type":"object[]","children":[{"sample":"2600144043","type":"int","name":"item_id","key":"WkmmJB","description":"Shopee's unique identifier for an item."},{"sample":"0","type":"int","name":"model_id","key":"KXEeYsd","description":"Shopee's unique identifier for a model."},{"description":"The number of identical items purchased at the same time by the same buyer from one listing/item.","name":"model_quantity","sample":"1","type":"int","required":null,"key":"pYaxdSS"}],"name":"item_list"},{"description":"For CB shop, display weight used to calculate actual_shipping_fee for this parcel.","name":"parcel_chargeable_weight_gram","sample":"500","type":"int","required":null,"key":"BNpRxaS"}],"name":"package_list"},{"description":"The invoice data of the order. pt: Nota Fiscal eletrÃ´nica (NF-e) do pedido.","sample":"","key":"psbTCXK","type":"object","children":[{"sample":"","type":"string","name":"number","key":"xcBNdzd","description":"The number of the invoice. The number should be 9 digits. pt: nÃºmero da NF-e."},{"sample":"","type":"string","name":"series_number","key":"ZByaYeC","description":"The series number of the invoice. The series number should be 3 digits. pt: sÃ©rie da NF-e."},{"sample":"","type":"string","name":"access_key","key":"sQdYpCk","description":"The access key of the invoice. The access key should be 44 digits. pt: chave de acesso da NF-e."},{"sample":"","type":"timestamp","name":"issue_date","key":"aYSfHxY","description":"The issue date of the invoice. The issue date should be later than the order pay date. pt: data de emissÃ£o da NF-e."},{"sample":"","type":"float","name":"total_value","key":"QxEBKHH","description":"The total value of the invoice. pt: valor total da NF-e (R$)."},{"sample":"","type":"float","name":"products_total_value","key":"JtMbbXX","description":"The products total value of the invoice. pt: valor total dos produtos (R$) da NF-e."},{"sample":"","type":"string","name":"tax_code","key":"ymRyHzB","description":"The tax code for the invoice. The tax code should be 4 digits. pt: CÃ³digo Fiscal de OperaÃ§Ãµes e PrestaÃ§Ãµes (CFOP) predominante na NF-e. "}],"name":"invoice_data"},{"sample":"Standard Delivery","type":"string","name":"checkout_shipping_carrier","key":"KHiGrc","description":"For non masking order, the logistics service provider that the buyer selected for the order to deliver items. For masking order, the logistics service type that the buyer selected for the order to deliver items."},{"sample":"","type":"float","name":"reverse_shipping_fee","key":"RSGXwTm","description":"Shopee charges the reverse shipping fee for the returned order.The value of this field will be non-negative."},{"description":"For CB shop, display weight used to calculate actual_shipping_fee for this order.","name":"order_chargeable_weight_gram","sample":"500","type":"int","required":null,"key":"KCcPHys"},{"description":"Earliest estimated delivery date of orders (only available for BR region)","name":"edt_from","sample":"","type":"timestamp","required":null,"key":"pHBHjKz"},{"description":"Latest estimated delivery date of orders (only available for BR region)","name":"edt_to","sample":"","type":"timestamp","required":null,"key":"zsyNXN"},{"description":"Return list of all prescription pictures of this order, only for ID whitelist user.","name":"prescription_images","sample":"","type":"string[]","required":null,"key":"KYPebWk"},{"description":"Return prescription check status of this order enum OrderPrescriptionCheckStatus: NONE = 0; PASSED = 1; FAILED = 2; only for ID whitelist user.","name":"prescription_check_status","sample":"","type":"int","required":null,"key":"MSfhWQb"}]
|""".stripMargin
    val columns: Array[Column] = toColumns(json).toArray
    println(util.JsonUtils.toJson(columns))
  }

  test("get product columns") {
    val json = """[{"sample":"3400133011","type":"int","name":"item_id","key":"GZzBTbf","description":"Shopee's unique identifier for an item."},{"sample":"14646","type":"int","name":"category_id","key":"yJaDeZF","description":"Shopee's unique identifier for a category."},{"sample":"seller discount","type":"string","name":"item_name","key":"ZdGdare","description":"Name of the item in local language."},{"sample":"first product 001first product","type":"string","name":"description","key":"HacSyaE","description":"if description_type is normal , Description information will be returned through this fieldï¼Œelse description will be empty"},{"sample":"","type":"string","name":"item_sku","key":"pFYWGBz","description":"An item SKU (stock keeping unit) is an identifier defined by a seller, sometimes called parent SKU. Item SKU can be assigned to an item in Shopee Listings."},{"sample":"1600572637","type":"timestamp","name":"create_time","key":"KBZSxwE","description":"Timestamp that indicates the date and time that the item was created."},{"sample":"1600572640","type":"timestamp","name":"update_time","key":"wrhBtGc","description":"Timestamp that indicates the last time that there was a change in value of the item. Including the fields: unlist, SearchableFlag sku, name, description, currency, images, brand, condition, weight, attributes, category, brand, estimate day, dimesion, size chart, india_tax_code, gtin, logisticsinfo, dangerous_goods, min_purchase_limit,videoinfo, hs_code, order_max_purchase_limit, status, add/delete model, update model option name, update model sku."},{"description":"","sample":"","key":"bHsPSfJ","type":"object[]","children":[{"sample":"4811","type":"int","name":"attribute_id","key":"kECwkfw","description":"The Identify of each category."},{"sample":"Brand: L2 Default [14644]","type":"string","name":"original_attribute_name","key":"nREksbh","description":"The name of each attribute."},{"sample":"true","type":"boolean","name":"is_mandatory","key":"pYHKFT","description":"This is to indicate whether this attribute is mandantory."},{"description":"","sample":"","key":"arkKkEC","type":"object[]","children":[{"sample":"0","type":"int","name":"value_id","key":"cjnJjrQ","description":"Unique identifier for value of this item attribute."},{"sample":"Default","type":"string","name":"original_value_name","key":"YxNCdiM","description":"Value name of this item attribute."},{"sample":"g","type":"string","name":"value_unit","key":"dtfnbBW","description":"Value unit of this item attribute."}],"name":"attribute_value_list"}],"name":"attribute_list"},{"description":"If the item has models, price_info will not be returned. Please get the price of each model through the get_model_list api.For SG/MY/BR/MX/PL/ES/AR seller: Sellers can set the price with two decimal place, other regions can only set the price as an integer.","sample":"","key":"CQdDdWy","type":"object[]","children":[{"sample":"SGD","type":"string","name":"currency","key":"SebwPJJ","description":"The three-digit code representing the currency unit used for the item in Shopee Listings."},{"sample":"122.1","type":"float","name":"original_price","key":"jzWDpjH","description":"The original price of the item in the listing currency."},{"sample":"122.1","type":"float","name":"current_price","key":"XtYwxhk","description":"The current price of the item in the listing currency. If product under a onging promotion, current_price will be the promotion price"},{"sample":"222.1","type":"float","name":"inflated_price_of_original_price","key":"PnZWiRp","description":"The After-tax original price of the item in the listing currency."},{"sample":"111.1","type":"float","name":"inflated_price_of_current_price","key":"pndpwDj","description":"The After-tax current price of the item in the listing currency."},{"sample":"100.1","type":"float","name":"sip_item_price","key":"SPCMCyK","description":"The price of the item in sip.If item is from SIP primary shop, this field will be returned."},{"sample":"auto","type":"string","name":"sip_item_price_source","key":"NpGbTXH","description":"source of sip' price. ( auto or manual). If item is from SIP primary shop, this field will be returned."},{"description":"The currency of sip_item_price.If item is from SIP primary shop, this field will be returned.","name":"sip_item_price_currency","sample":"CNY","type":"string","required":null,"key":"ztSGrC"}],"name":"price_info"},{"description":"","sample":"","key":"FjPXyZM","type":"object","children":[{"sample":"","type":"string[]","name":"image_url_list","key":"MBYizea","description":"List of image url."},{"sample":"","type":"string[]","name":"image_id_list","key":"pkjZBHa","description":"List of image id."}],"name":"image"},{"sample":"\"0.01\"","type":"string","name":"weight","key":"JcfnYyt","description":"The net weight of this item, the unit is KG."},{"description":"The dimension of this item.","sample":"","key":"QbphtTp","type":"object","children":[{"sample":"11","type":"int","name":"package_length","key":"PbaMdcY","description":"The length of package for this single item, the unit is CM."},{"sample":"12","type":"int","name":"package_width","key":"XZxGWwW","description":"The width of package for this single item, the unit is CM."},{"sample":"13","type":"int","name":"package_height","key":"AiNaGTM","description":"The height of package for this single item, the unit is CM."}],"name":"dimension"},{"description":"The logistics list.","sample":"","key":"tQybiiG","type":"object[]","children":[{"sample":"80012","type":"int","name":"logistic_id","key":"eFknKZj","description":"The identity of logistic channel."},{"sample":"","type":"string","name":"logistic_name","key":"GscRdcr","description":"The name of logistic."},{"sample":"true","type":"boolean","name":"enabled","key":"RDhCeiY","description":"Related to shopee.logistics.GetLogistics result.logistics.enabled only affect current item."},{"sample":"5.1","type":"float","name":"shipping_fee","key":"sFFyYiC","description":"Only needed when logistics fee_type = CUSTOM_PRICE."},{"sample":"","type":"int","name":"size_id","key":"FKrFzJP","description":"If specify logistic fee_type is SIZE_SELECTION size_id is required."},{"sample":"false","type":"boolean","name":"is_free","key":"MECQBSW","description":"when seller chooses this option, the shipping fee of this channel on item will be set to 0. Default value is False."},{"sample":"4.1","type":"float","name":"estimated_shipping_fee","key":"aSXwPhX","description":"Estimated shipping fee calculated by weight. Don't exist if channel is no-integrated."}],"name":"logistic_info"},{"description":"","sample":"","key":"szdbkxE","type":"object","children":[{"sample":"false","type":"boolean","name":"is_pre_order","key":"retQsJG","description":" Pre-order will be set true."},{"sample":"3","type":"int","name":"days_to_ship","key":"WmDMDWa","description":"The days to ship. Only work for pre-order, it means this value should be bigger than 7."}],"name":"pre_order"},{"description":"The wholesales tier list.","sample":"","key":"KReeCwy","type":"object[]","children":[{"sample":"1","type":"int","name":"min_count","key":"jZSRSjx","description":"The min count of this tier wholesale."},{"sample":"2","type":"int","name":"max_count","key":"mcNQMXD","description":"The max count of this tier wholesale."},{"sample":"4.1","type":"float","name":"unit_price","key":"tDNnFDh","description":"The current price of the wholesale in the listing currency.If item is in promotion, this price is useless."},{"sample":"5.02","type":"float","name":"inflated_price_of_unit_price","key":"tkiFMCE","description":"The After-tax Price of the wholesale show to buyer."}],"name":"wholesales"},{"sample":"NEW/USED","type":"string","name":"condition","key":"bNZCfwb","description":"Is it second-hand."},{"sample":"","type":"string","name":"size_chart","key":"Apbazbf","description":"Url of size chart image."},{"sample":"NORMAL","type":"string","name":"item_status","key":"SfjeDyY","description":"Enumerated type that defines the current status of the item. Applicable values: NORMAL, DELETED, BANNED and UNLIST."},{"sample":"false","type":"boolean","name":"has_model","key":"mBKZkE","description":"Does it contain model."},{"sample":"13123","type":"int","name":"promotion_id","key":"fMfyZGh","description":""},{"description":"Info of video list.","sample":"","key":"zNzwexH","type":"object[]","children":[{"sample":"","type":"string","name":"video_url","key":"JhEMPbb","description":"Url of video."},{"sample":"","type":"string","name":"thumbnail_url","key":"tZXtRJX","description":"Thumbnail of video."},{"sample":"","type":"int","name":"duration","key":"ATfNykG","description":"Duration of video."}],"name":"video_info"},{"description":"","sample":"","key":"MfisKic","type":"object","children":[{"sample":"123","type":"int","name":"brand_id","key":"dxSHPjC","description":"Id of brand."},{"sample":"nike","type":"string","name":"original_brand_name","key":"DcsSriC","description":"Original name of brand."}],"name":"brand"},{"sample":"0","type":"int","name":"item_dangerous","key":"dQbCGiD","description":"This field is only applicable for local sellers in Indonesia and Malaysia. Use this field to identify whether a product is a dangerous product. 0 for non-dangerous product and 1 for dangerous product. For more information, please visit the market's respective Seller Education Hub."},{"description":"Time for a warranty claim.Value should be in one of ONE_YEAR TWO_YEARS OVER_TWO_YEARS.","required":null,"sample":"","key":"zSWpkbH","type":"object","children":[{"description":"Time for a warranty claim.Value should be in one of ONE_YEAR TWO_YEARS OVER_TWO_YEARS.","required":null,"sample":" ONE_YEAR","key":"EMWBpsN","type":"string","name":"warranty_time"},{"description":"If True means \"I exclude warranty complaints for entrepreneur\"","required":null,"sample":"true","key":"SDDPF","type":"boolean","name":"exclude_entrepreneur_warranty"},{"description":"The identity of complaint address.","required":null,"sample":"","key":"HYFSYji","type":"int","name":"complaint_address_id"},{"description":"Additional information for complaint policy","required":null,"sample":"","key":"YWyaEDW","type":"string","name":"additional_information"}],"name":"complaint_policy"},{"description":"Tax information","required":null,"sample":"","key":"FeRsCD","type":"object","children":[{"description":"Mercosur Common Nomenclature, it is a convention between Mercosur member countries to easily recognize goods, services and productive factors negotiated among themselves.(only for BR region)","required":null,"sample":"","key":"bbrPheQ","type":"string","name":"ncm"},{"description":"Tax Code of Operations and Installments for orders that seller and buyer are in different states. It identifies a specific operation by category at the time of issuing the invoice. (only for BR region)","required":null,"sample":"","key":"cPjBbwM","type":"string","name":"diff_state_cfop"},{"description":"Code of Operation Status â€“ Simples Nacional, code for company operations to identify the origin of the goods and the taxation regime of the operations. (only for BR region)","required":null,"sample":"","key":"fMSKWCh","type":"string","name":"csosn"},{"description":"Product source, domestic or foreig (only for BR region)","required":null,"sample":"","key":"tGGBmc","type":"string","name":"origin"},{"description":"(only for BR region)","required":null,"sample":"","key":"WNNBDe","type":"string","name":"cest"},{"description":"(only for BR region)","required":null,"sample":"","key":"eRJQZhE","type":"string","name":"measure_unit"},{"description":"Value shuold be one of NO_INVOICES VAT_MARGIN_SCHEME_INVOICES / VAT_INVOICES / NON_VAT_INVOICES and if value is NON_VAT_INVOICE vat_rate should be null (only for PL region)","required":null,"sample":"","key":"ietbWAi","type":"string","name":"invoice_option"},{"description":"Value should be one of 0% / 5% / 8% / 23% / NO_VAT_RATE (only for PL region)","required":null,"sample":"","key":"kaNEGES","type":"string","name":"vat_rate"},{"description":"HS Code (Only for IN region)","required":null,"sample":"","key":"CBkDNBm","type":"string","name":"hs_code"},{"description":"Tax Code (Only for IN region)","required":null,"sample":"","key":"KDKyNZD","type":"string","name":"tax_code"},{"description":"tax_type only return for tw whitelist shop","name":"tax_type","sample":"","type":"int","required":null,"key":"iyinmaE"}],"name":"tax_info"},{"description":"new stock object.Please check this FAQ for more detail: https://open.shopee.com/faq?top=162&sub=166&page=1&faq=230","required":null,"sample":"","key":"chdnmrp","type":"object","children":[{"description":"stock summary info","required":null,"sample":"","key":"HQenTZk","type":"object","children":[{"description":"total reserved stock","required":null,"sample":"100","key":"zTwHTdT","type":"int","name":"total_reserved_stock"},{"description":"total available stock","required":null,"sample":"100","key":"fdEKbbf","type":"int","name":"total_available_stock"}],"name":"summary_info"},{"description":"seller stock","required":null,"sample":"","key":"fyKwrmd","type":"object[]","children":[{"description":"","required":null,"sample":"location id","key":"HaXnAyj","type":"string","name":"location_id"},{"description":"stock in the current warehouse","required":null,"sample":"10","key":"sehekG","type":"int","name":"stock"}],"name":"seller_stock"},{"description":"shopee stock","required":null,"sample":"","key":"JxYfcfQ","type":"object[]","children":[{"description":"","required":null,"sample":"","key":"DiyHEwa","type":"string","name":"location_id"},{"description":"stock in the current warehouse","required":null,"sample":"","key":"KGZrFsw","type":"int","name":"stock"}],"name":"shopee_stock"}],"name":"stock_info_v2"},{"description":"New description field. Only whitelist sellers can use it.","name":"description_info","sample":"","type":"object","required":null,"key":"aTXNmXQ","children":[{"description":"If description_type is extended , Description information will be returned through this field.","name":"extended_description","sample":"","type":"object","required":null,"key":"znwJfh","children":[{"description":"Field of extended description","name":"field_list","sample":"","type":"object[]","required":null,"key":"aGPsXwd","children":[{"description":"description_field_type (text , image).","name":"field_type","sample":"","type":"string","required":null,"key":"aeWzPSM"},{"description":"If field_type is text, text information will be returned through this field.","name":"text","sample":"","type":"string","required":null,"key":"XrmCcDX"},{"description":"If field_type is image, image url will be returned through this field.","name":"image_info","sample":"","type":"object","required":null,"key":"WwmFHmK","children":[{"description":"Image id","name":"image_id","sample":"","type":"string","required":null,"key":"JjFhWPm"},{"description":"Image url.","name":"image_url","sample":"","type":"string","required":null,"key":"rWkYYDQ"}]}]}]}]},{"description":"Type of description : values: See Data Definition- description_type (normal , extended).","name":"description_type","sample":"","type":"string","required":null,"key":"BeFttjB"},{"description":"(only for BR Local seller) This field will return when the item has no model and BR local seller have uploaded the gtin_code.","name":"gtin_code","sample":"","type":"string","required":null,"key":"yEWHckK"}]"""
    val columns: Array[Column] = toColumns(json).toArray
    println(util.JsonUtils.toJson(columns))
  }

  test("get category columns") {
    val json = """[{"sample":"1234","type":"int","name":"category_id","key":"MpQFrmJ","description":"ID for category."},{"sample":"1234","type":"int","name":"parent_category_id","key":"CZBaRYr","description":"ID for parent category."},{"sample":"å†…è¡£","type":"string","name":"original_category_name","key":"YtbjHDi","description":"Default name for category."},{"sample":"å†…è¡£","type":"string","name":"display_category_name","key":"etRsEYc","description":"Display name dependent on display name."},{"sample":"false","type":"boolean","name":"has_children","key":"yhRfXcS","description":"Whether this category has active children category."}]"""
    val columns: Array[Column] = toColumns(json).toArray
    println(util.JsonUtils.toJson(columns))
  }

  test("get shopee store performance") {
    val json = """[{"sample":"1","type":"int","name":"overall_performance","description":"1-Excellent,  2-Good,  3-Improvement needed,  4-Poor","key":"EsCabm"},{"sample":"","type":"object","description":"The listing related violations","name":"listing_violations","children":[{"sample":"","type":"object","description":"Listings are deleted if they constitute a serious violation of Shopee's policies. Sellers who violate our policy will earn penalty points under the Seller Penalty Points system. From 7th May 2018 onwards, sellers with a high number of spam, prohibited and/or counterfeit listings will receive 2 penalty points.","name":"severe_listing_violations","children":[{"sample":"","type":"object","description":"Overall data of severe listing violation","name":"total_data","children":[{"sample":"0","type":"string","name":"target","description":"","key":"fstHPiw"},{"sample":"1","type":"string","name":"my_shop_performance","description":"","key":"iWFcWid"},{"sample":"1","type":"string","name":"penalty_points","description":"","key":"YFYEDkp"}],"key":"WRfxbk"},{"sample":"","type":"object","description":"Spam listings contain irrelevant and misleading information used to manipulate search results. This includes: - Duplicate listings (products with no significant difference) - Price spam listings (setting very low / high prices with no intention to sell) - Keyword spam listings (irrelevant keywords in product title) - Attribute spam listings (incorrect product information)","name":"spam_listing_data","children":[{"sample":"0","type":"string","name":"target","description":"","key":"NbmEaFh"},{"sample":"1","type":"string","name":"my_shop_performance","description":"","key":"ESyJYiM"},{"sample":"2","type":"string","name":"penalty_points","description":"","key":"YKhhbGx"}],"key":"PcRaJei"},{"sample":"","type":"object","description":"Sellers should only list authentic products. Counterfeit items are products that were made in exact imitation of an existing brand with the intention to deceive or defraud, and may include, but are not limited to: - Products that are fake or replicas of an existing official product - Products that have never been produced by a specific brand - Products that bear such similarities with other products (e.g. a replica of a branded item with or without altered logos) without the authorization of the trademark owner","name":"counterfeit_ip_infringement_data","children":[{"sample":"0","type":"string","name":"target","description":"","key":"XzZAsJ"},{"sample":"1","type":"string","name":"my_shop_performance","description":"","key":"FNZyTPa"},{"sample":"3","type":"string","name":"penalty_points","description":"","key":"pmkHjzn"}],"key":"JTrzGnf"},{"sample":"","type":"object","description":"Prohibited listings are products that are not allowed on Shopee. This includes: - Listings that do not comply with local regulations or Shopeeâ€™s Listing Policy; - Listings that advertise for services / products not intended for sale on Shopee - Listings that intent to direct transaction outside of Shopee - Listings edited to sell a different item from the original listing, to mislead buyers on actual sold count or product review","name":"prohibited_listing_data","children":[{"sample":"0","type":"string","name":"target","description":"","key":"fSXfcnK"},{"sample":"1","type":"string","name":"my_shop_performance","description":"","key":"YSdeFMB"},{"sample":"2","type":"string","name":"penalty_points","description":"","key":"CtHAcpf"}],"key":"FpHtxPK"}],"key":"aZmNms"},{"sample":"","type":"object","description":"Live pre-order listings as a percentage of total live listings.","name":"pre_order_listing","children":[{"sample":"","type":"object","description":"","name":"percent_pre_order_listing_data","children":[{"sample":"0","type":"string","name":"target","description":"","key":"DTdJej"},{"sample":"13.00%","type":"string","name":"my_shop_performance","description":"","key":"DyeheMF"},{"sample":"null","type":"string","name":"penalty_points","description":"","key":"aJQbZz"}],"key":"QfXzNtf"},{"sample":"","type":"object","description":"The number of days in the last 30 days where pre-order listing precentage exceeds target ","name":"number_of_days_pre_order_listing_exceeds_target_da","children":[{"sample":"0","type":"string","name":"target","description":"","key":"KtPMTAm"},{"sample":"7","type":"string","name":"my_shop_performance","description":"","key":"wtaEGws"},{"sample":"null","type":"string","name":"penalty_points","description":"","key":"mbbACWW"}],"key":"HQNkfad"}],"key":"QXxdspx"},{"sample":"","type":"object","description":"Listings may also be suspended or deleted if they: - Are listed in the wrong categories - Have poor quality images - Have inaccurate description or insufficient details as required by local regulations - Do not meet Shopee's listings requirements","name":"other_listing_violations","children":[{"sample":"","type":"object","description":"","name":"total_data","children":[{"sample":"0","type":"string","name":"target","description":"","key":"rcGbKih"},{"sample":"2","type":"string","name":"my_shop_performance","description":"","key":"kkPQbkp"},{"sample":"null","type":"string","name":"penalty_points","description":"","key":"pbQsBFy"}],"key":"mjsJnK"}],"key":"xykHbyr"}],"key":"bGDtcDT"},{"sample":"","type":"object","description":"","name":"fulfillment","children":[{"sample":"","type":"object","description":"Non-fulfilment rate is the percentage of orders (out of total orders) that were either cancelled or returned in the past 7 days. Only orders cancelled by sellers are taken into consideration when computing non-fulfilment rate. Non-fulfilment rate is also the sum of your cancellation rate and return-refund rate.","name":"non_fulfillment_rate","children":[{"sample":"","type":"object","description":"","name":"total_data","children":[{"sample":"<10.00%","type":"string","name":"target","description":"","key":"MXcCTpr"},{"sample":"9.00%","type":"string","name":"my_shop_performance","description":"","key":"WihJpfd"},{"sample":"5","type":"string","name":"penalty_points","description":"","key":"SwZEzKS"}],"key":"bRKxmhG"},{"sample":"","type":"object","description":"Cancellation rate is the percentage of orders (out of total orders) cancelled by a seller in the past 7 days. Buyers initiated cancellations are not included in the calculation.","name":"cancellation_rate_data","children":[{"sample":"<10.00%","type":"string","name":"target","description":"","key":"ZjMcYTS"},{"sample":"5.00%","type":"string","name":"my_shop_performance","description":"","key":"eJnEHPQ"},{"sample":"null","type":"string","name":"penalty_points","description":"","key":"ctbBkPi"}],"key":"JaDXyTS"},{"sample":"","type":"object","description":"Return-refund rate is the percentage of orders (out of total orders) that were requested by buyers for a return-refund in the past 7 days. Tips","name":"return_refund_rate_data","children":[{"sample":"<10.00%","type":"string","name":"target","description":"","key":"NsawBFR"},{"sample":"12.00%","type":"string","name":"my_shop_performance","description":"","key":"QNDiEpy"},{"sample":"null","type":"string","name":"penalty_points","description":"","key":"mceJnCz"}],"key":"hDYzpzt"}],"key":"QsktpBf"},{"sample":"","type":"object","description":"Preparation time is the number of days it takes a seller to prepare and ship out an order.","name":"preparation_time","children":[{"sample":"","type":"object","description":"","name":"total_data","children":[{"sample":"< 2.00 days","type":"string","name":"target","description":"","key":"MPyejEs"},{"sample":"1.72 days","type":"string","name":"my_shop_performance","description":"","key":"krNJcFm"},{"sample":"null","type":"string","name":"penalty_points","description":"","key":"iMwYFhi"}],"key":"McwGwCs"}],"key":"arTjHke"},{"sample":"","type":"object","description":"Late shipment rate is the percentage of orders (out of total orders) that were shipped late in the past 7 days. You should maintain your late shipment rate at a healthy level of <2%. If your late shipment rate exceeds %, you will receive a penalty point under the Seller Penalty Points system. One additional penalty point will be issued to seller who exceeds % and has a very high number of late shipped orders (>=50 orders).","name":"late_shipment_rate","children":[{"sample":"","type":"object","description":"","name":"total_data","children":[{"sample":"<10.00%","type":"string","name":"target","description":"","key":"HweshyE"},{"sample":"9.00%","type":"string","name":"my_shop_performance","description":"","key":"DkHMfTB"},{"sample":"5","type":"string","name":"penalty_points","description":"","key":"xzHkrKx"}],"key":"zdhrAB"}],"key":"wCnDNJM"}],"key":"SHGxnSs"},{"sample":"","type":"object","description":"","name":"customer_service","children":[{"sample":"","type":"object","description":"Chat response rate is the percentage of new chats and offers (out of total) that a seller responds to within 12 hours of receiving them. Auto replies are not included in the chat response rate computation.","name":"response_rate","children":[{"sample":"","type":"object","description":"","name":"total_data","children":[{"sample":"> 57.00%","type":"string","name":"target","description":"","key":"FSFGwfz"},{"sample":"57.00%","type":"string","name":"my_shop_performance","description":"","key":"sDSNnfK"},{"sample":"null","type":"string","name":"penalty_points","description":"","key":"SGmpCfC"}],"key":"HaKXrZ"}],"key":"QnyDYFw"},{"sample":"","type":"object","description":"Chat response time is the average time it takes a seller to respond to a buyer's chat message.","name":"response_time","children":[{"sample":"","type":"object","description":"","name":"total_data","children":[{"sample":"< 1.00days","type":"string","name":"target","description":"","key":"DzQdywE"},{"sample":"0.25days","type":"string","name":"my_shop_performance","description":"","key":"rykket"},{"sample":"null","type":"string","name":"penalty_points","description":"","key":"pRkPHnb"}],"key":"QKyCRc"}],"key":"RxkxpiZ"}],"key":"yNyGwSG"},{"sample":"","type":"object","description":"","name":"customer_satisfaction","children":[{"sample":"","type":"object","description":"Overall review rating is the average of all order ratings submitted by your buyers.","name":"overall_reviewing_rate","children":[{"sample":"","type":"object","description":"","name":"total_data","children":[{"sample":">=4.50/5","type":"string","name":"target","description":"","key":"BJkcRWJ"},{"sample":"4.05/5","type":"string","name":"my_shop_performance","description":"","key":"FTRdcyJ"},{"sample":"null","type":"string","name":"penalty_points","description":"","key":"wbDtijp"}],"key":"kYNaRtp"}],"key":"kawHjHS"}],"key":"DwcxAKX"}]"""
    val columns: Array[Column] = toColumns(json).toArray
    println(util.JsonUtils.toJson(columns))
  }

  private def toColumns(json: String): Seq[Column] = {
    val jsonNodeList = util.JsonUtils.fromJson[Seq[JsonNode]](json)
    val columnAsJsonList: Seq[String] = jsonNodeList.flatMap { jsonNode => {
      val `type` = jsonNode.get("type").asText()
      val description = jsonNode.get("description").asText()
      val name = jsonNode.get("name").asText()
      val children = jsonNode.get("children")
      toColumnJsonList(name, `type`, description, children)

    }
    }
    val columnsAsJson: String =
      s"""[
         | ${columnAsJsonList.mkString(", ")}
         |]""".stripMargin
    util.JsonUtils.fromJson[Seq[Column]](columnsAsJson)
  }

  private def toColumnJsonList(name: String, `type`: String, description: String, children: JsonNode): Seq[String] = {
    if (`type` == "object") {
      val jsonNodeList: Seq[JsonNode] = children.elements().asScala.toList
      val columnAsJsonList: Seq[String] = jsonNodeList.flatMap { jsonNode =>
        {
          val `type` = jsonNode.get("type").asText()
          val description = jsonNode.get("description").asText()
          val childName = jsonNode.get("name").asText()
          val children = jsonNode.get("children")
          toColumnJsonList(s"${name}.${childName}", `type`, description, children)
        }
      }
      columnAsJsonList
    } else {
      val columnAsJson =
        s"""{
           | "class_name": "${getClassName(`type`)}",
           | "description": "${String.valueOf(description).replaceAll("\"", "'").trim()}",
           | "name": "${String.valueOf(name).trim}",
           | "display_name": "${String.valueOf(name).trim}",
           | "is_nullable": true,
           | "is_encrypted": false
           |}""".stripMargin
      Seq(columnAsJson)
    }
  }

  private def getClassName(`type`: String): String = {
    `type` match {
      case "string"    => "string"
      case "int"       => "int32"
      case "float"     => "double"
      case "timestamp" => "int64"
      case "boolean"   => "bool"
      case "object[]"  => "string"
      case "string[]"  => "string"
      case _           => throw InternalError(s"Unknown type: ${`type`}")
    }
  }

}
